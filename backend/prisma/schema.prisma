// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 Int      @id @default(autoincrement())
  email              String   @unique
  name               String?
  password           String
  role               String   @default("user") // Add role field, default to user
  avatarUrl          String? // 可选，用于存储头像路径
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  isEmailVerified    Boolean  @default(false) // <-- 添加邮箱验证状态
  posts              Post[]   // 用户发布的所有帖子
  comments           Comment[] // 用户的所有评论
  likes              Like[]    // 用户收到的赞
  notifications      Notification[] @relation("UserNotifications") // 用户收到的通知
  sentNotifications  Notification[] @relation("UserNotificationSender") // 用户发出的通知
  favorites          Favorite[] // 用户的收藏
  passwordResetCodes PasswordResetCode[] // <-- 添加反向关联
  emailVerificationCodes EmailVerificationCode[] // <-- 添加反向关联
}

model Post {
  id          Int        @id @default(autoincrement())
  title       String
  content     String?    // Made content optional for consistency
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  author      User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId    Int
  comments    Comment[]  // 帖子的所有评论
  likes       Like[]     // 帖子收到的赞
  imageUrl    String?    @unique // Correctly add @unique to the existing field
  tags        Tag[]      @relation // Implicit M2M: Removed references: [id]
  favoritedBy Favorite[] // 帖子被哪些用户收藏
  notifications Notification[] // Added inverse relation for Notification.post
  isShowcase  Boolean    @default(false)

  @@index([authorId])
}

model Like {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int

  @@unique([postId, userId]) // 一个用户只能对一个帖子点赞一次
}

model Comment {
  id        Int      @id @default(autoincrement())
  text      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    Int
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId  Int
  notification Notification? 

  // Add parent/reply relation
  parentId  Int?      // Optional ID of the parent comment
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade, map: "comment_parentId_fkey") // Added explicit map name for clarity
  replies   Comment[] @relation("CommentReplies") // List of replies to this comment
}

model Notification {
  id           Int       @id @default(autoincrement())
  type         String    // e.g., 'LIKE', 'COMMENT', 'FAVORITE'
  isRead       Boolean   @default(false)
  createdAt    DateTime  @default(now())
  recipient    User      @relation("UserNotifications", fields: [recipientId], references: [id], onDelete: Cascade)
  recipientId  Int       // 通知接收者 (通常是帖子作者)
  sender       User?     @relation("UserNotificationSender", fields: [senderId], references: [id], onDelete: SetNull)
  senderId     Int?      // 触发通知的用户 (点赞者、评论者、收藏者)
  postId       Int?      // 关联的帖子ID (可选)
  post         Post?     @relation(fields: [postId], references: [id], onDelete: Cascade)
  commentId    Int?      @unique // 关联的评论ID (仅用于评论通知) - Added @unique for one-to-one
  comment      Comment?  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  message      String?   // Pre-generated message if needed

  @@index([recipientId]) // Index for querying user's notifications
  @@index([postId])      // Index for notifications related to a post
}

model Tag {
  id            Int            @id @default(autoincrement())
  name          String         @unique
  isFixed       Boolean        @default(false)
  posts         Post[]         @relation // Existing relation
  foodShowcases FoodShowcase[] @relation // Add relation to FoodShowcase
}

model Favorite {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  userId    Int
  postId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId]) // 确保用户对同一帖子的收藏是唯一的
}

// 新增：用于纯粹展示美食图片，与帖子系统分离
model FoodShowcase {
  id          Int      @id @default(autoincrement())
  imageUrl    String
  title       String?  
  description String?
  createdAt   DateTime @default(now())
  tags        Tag[]    @relation // Add relation field to Tag

  @@index([createdAt])
  @@index([title])
  @@index([description])
}

// 新增：用于存储密码重置验证码
model PasswordResetCode {
  id        Int      @id @default(autoincrement())
  code      String   // 验证码
  userId    Int      // 关联的用户ID
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime // 过期时间
  createdAt DateTime @default(now())

  @@unique([userId, code]) // 一个用户可能同时请求多个，但特定code应唯一
  @@index([userId])
  @@index([expiresAt]) // 用于快速查找过期记录
}

// 新增：用于存储邮箱验证码
model EmailVerificationCode {
  id        Int      @id @default(autoincrement())
  code      String   @unique // 验证码或Token，设为unique
  userId    Int      // 关联的用户ID
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime // 过期时间
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}
