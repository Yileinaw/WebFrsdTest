import{d as R,N as T,r as g,X as V,o as B,aJ as M,c as D,w as s,an as f,a as o,q as y,t as j,y as I,A as p,aI as U,D as A,_ as H}from"./index-B8L1PXQk.js";const J=R({__name:"EditProfileView",setup(O){const w=T(),v=g(!1),C=g("edit"),u=V({name:"",bio:""}),P=g(),l=V({oldPassword:"",newPassword:"",confirmPassword:"",code:""}),_=g(!1),c=g(0);let m;const b=g(!1),S=V({oldPassword:[{required:!0,message:"请输入旧密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度至少为6位",trigger:"blur"}],confirmPassword:[{required:!0,validator:(t,e,a)=>{e===""?a(new Error("请再次输入新密码")):e!==l.newPassword?a(new Error("两次输入的新密码不一致!")):a()},trigger:"blur"}],code:[{required:!0,message:"请输入邮箱验证码",trigger:"blur"},{len:6,message:"验证码必须为6位",trigger:"blur"}]});B(()=>{w.currentUser&&(u.name=w.currentUser.name||"",u.bio=w.currentUser.bio||"")});const k=async()=>{var e,a,r,n;v.value=!0;const t={};if(u.name!==(((e=w.currentUser)==null?void 0:e.name)||"")&&(t.name=u.name),u.bio!==(((a=w.currentUser)==null?void 0:a.bio)||"")&&(t.bio=u.bio),Object.keys(t).length===0){p.info("未检测到资料更改"),v.value=!1;return}console.log("Updating profile:",t);try{const i=await U.updateMyProfile(t);w.updateUserInfo(i.user),p.success("个人资料更新成功")}catch(i){console.error("Profile update failed:",i),p.error(((n=(r=i.response)==null?void 0:r.data)==null?void 0:n.message)||"更新失败，请稍后重试")}finally{v.value=!1}},q=async()=>{var t,e;_.value=!0;try{const a=await U.sendPasswordResetCode();p.success(a.message||"验证码已发送"),c.value=60,m&&clearInterval(m),m=setInterval(()=>{c.value--,c.value<=0&&(clearInterval(m),m=void 0)},1e3)}catch(a){console.error("Send code failed:",a),p.error(((e=(t=a.response)==null?void 0:t.data)==null?void 0:e.message)||"发送验证码失败")}finally{_.value=!1}},E=async()=>{P.value&&await P.value.validate(async t=>{var e,a,r;if(t){b.value=!0;try{const n={oldPassword:l.oldPassword,newPassword:l.newPassword,code:l.code,confirmPassword:""};delete n.confirmPassword;const i=await U.changePassword(n);p.success(i.message||"密码修改成功"),(e=P.value)==null||e.resetFields()}catch(n){console.error("Change password failed:",n),p.error(((r=(a=n.response)==null?void 0:a.data)==null?void 0:r.message)||"密码修改失败")}finally{b.value=!1}}else console.log("Password form validation failed")})};return M(()=>{m&&clearInterval(m)}),(t,e)=>{const a=f("el-input"),r=f("el-form-item"),n=f("el-button"),i=f("el-form"),x=f("el-tab-pane"),F=f("el-tabs"),N=f("el-card");return A(),D(N,{class:"user-profile-card"},{header:s(()=>e[7]||(e[7]=[I("div",{class:"card-header"},[I("span",null,"账号设置")],-1)])),default:s(()=>[o(F,{modelValue:C.value,"onUpdate:modelValue":e[6]||(e[6]=d=>C.value=d)},{default:s(()=>[o(x,{label:"编辑资料",name:"edit"},{default:s(()=>[o(i,{model:u,"label-width":"80px",class:"edit-form"},{default:s(()=>[o(r,{label:"昵称"},{default:s(()=>[o(a,{modelValue:u.name,"onUpdate:modelValue":e[0]||(e[0]=d=>u.name=d)},null,8,["modelValue"])]),_:1}),o(r,{label:"简介"},{default:s(()=>[o(a,{type:"textarea",modelValue:u.bio,"onUpdate:modelValue":e[1]||(e[1]=d=>u.bio=d),rows:3},null,8,["modelValue"])]),_:1}),o(r,null,{default:s(()=>[o(n,{type:"primary",onClick:k,loading:v.value},{default:s(()=>e[8]||(e[8]=[y("保存资料")])),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1}),o(x,{label:"修改密码",name:"password"},{default:s(()=>[o(i,{model:l,rules:S,ref_key:"passwordFormRef",ref:P,"label-width":"100px",class:"password-form"},{default:s(()=>[o(r,{label:"旧密码",prop:"oldPassword"},{default:s(()=>[o(a,{type:"password",modelValue:l.oldPassword,"onUpdate:modelValue":e[2]||(e[2]=d=>l.oldPassword=d),"show-password":""},null,8,["modelValue"])]),_:1}),o(r,{label:"新密码",prop:"newPassword"},{default:s(()=>[o(a,{type:"password",modelValue:l.newPassword,"onUpdate:modelValue":e[3]||(e[3]=d=>l.newPassword=d),"show-password":""},null,8,["modelValue"])]),_:1}),o(r,{label:"确认新密码",prop:"confirmPassword"},{default:s(()=>[o(a,{type:"password",modelValue:l.confirmPassword,"onUpdate:modelValue":e[4]||(e[4]=d=>l.confirmPassword=d),"show-password":""},null,8,["modelValue"])]),_:1}),o(r,{label:"验证码",prop:"code"},{default:s(()=>[o(a,{modelValue:l.code,"onUpdate:modelValue":e[5]||(e[5]=d=>l.code=d),style:{width:"150px","margin-right":"10px"}},null,8,["modelValue"]),o(n,{onClick:q,disabled:_.value||c.value>0},{default:s(()=>[y(j(c.value>0?`${c.value}秒后重发`:"发送验证码"),1)]),_:1},8,["disabled"])]),_:1}),o(r,null,{default:s(()=>[o(n,{type:"primary",onClick:E,loading:b.value},{default:s(()=>e[9]||(e[9]=[y("确认修改")])),_:1},8,["loading"])]),_:1})]),_:1},8,["model","rules"])]),_:1})]),_:1},8,["modelValue"])]),_:1})}}}),z=H(J,[["__scopeId","data-v-381fcf26"]]);export{z as default};
