import{d as J,N as K,r as m,X as M,o as Q,G as c,y as w,c as x,a as s,q as f,w as n,u as a,J as W,a7 as X,P as H,e as S,Q as O,S as Y,v as Z,x as ee,ag as te,T as V,aC as ae,aF as le,h as k,aG as oe,aK as se,ai as b,f as z,I as re,a9 as B,aj as ne,t as ie,ak as de,A as g,ah as D,D as i,_ as ue}from"./index-B8L1PXQk.js";import{S as ce}from"./ShareCard-B8eI0k-J.js";import"./default-food-DJ8mVkvR.js";import"./formatters-Ce3ZkgnQ.js";const pe={class:"personal-center-view"},me={class:"view-title"},ge={key:0,class:"loading-state"},fe={key:2},ve={key:0,class:"posts-grid"},ye={class:"post-actions-manage"},ke={key:2,class:"pagination-section"},_e={key:0,class:"current-image-preview"},Ee={key:2,style:{color:"red","font-size":"12px","margin-top":"5px"}},Ue={class:"dialog-footer"},we={name:"MyPostsView"},xe=J({...we,setup(Pe){const F=K(),u=m([]),U=m(!0),_=m(null),d=M({currentPage:1,pageSize:10,total:0}),E=m(!1),I=m(null),P=m(),o=M({id:0,title:"",content:"",imageUrl:null}),h=m(!1),v=m(null),C=async(l=1)=>{var e,t;U.value=!0,_.value=null;try{const r=await V.getMyPosts({page:l,limit:d.pageSize});u.value=r.posts||[],d.total=0,d.currentPage=l}catch(r){console.error("Error fetching my posts:",r),_.value=((t=(e=r.response)==null?void 0:e.data)==null?void 0:t.message)||"加载我的帖子列表失败",u.value=[],d.total=0}finally{U.value=!1}},L=l=>{C(l)},N=async l=>{var e,t;try{await V.deletePost(l),g.success("帖子删除成功"),C(d.currentPage)}catch(r){console.error("Error deleting post:",r),g.error(((t=(e=r.response)==null?void 0:e.data)==null?void 0:t.message)||"删除帖子失败")}},$=l=>{I.value=l,o.id=l.id,o.title=l.title,o.content=l.content||"",o.imageUrl=l.imageUrl||null,v.value=null,E.value=!0},A=l=>{const e=l.type.startsWith("image/"),t=l.size/1024/1024<5;return e||g.error("请上传图片格式文件!"),t||g.error("图片大小不能超过 5MB!"),v.value=null,e&&t},q=async l=>{var t,r;const e=new FormData;e.append("image",l.file),v.value=null;try{const y=`${D.defaults.baseURL}/posts/upload-image`,p=await D.post(y,e,{headers:{"Content-Type":"multipart/form-data",Authorization:`Bearer ${F.token}`}});o.imageUrl=p.data.imageUrl,g.success("图片上传成功")}catch(y){console.error("Upload error:",y);const p=((r=(t=y.response)==null?void 0:t.data)==null?void 0:r.message)||"图片上传失败";v.value=p,g.error(p)}},R=()=>{o.imageUrl=null},T=async()=>{P.value&&await P.value.validate(async l=>{var e,t;if(l){h.value=!0;try{const r={title:o.title,content:o.content,imageUrl:o.imageUrl},y=await V.updatePost(o.id,r),p=u.value.findIndex(G=>G.id===o.id);p!==-1&&(u.value[p]={...u.value[p],...y.post}),g.success("帖子更新成功"),E.value=!1}catch(r){console.error("Save edit error:",r),g.error(((t=(e=r.response)==null?void 0:e.data)==null?void 0:t.message)||"更新失败")}finally{h.value=!1}}})},j=l=>{const e=u.value.findIndex(t=>t.id===l.id);e!==-1&&(u.value[e]={...u.value[e],...l})};return Q(()=>{C(d.currentPage)}),(l,e)=>(i(),c("div",pe,[w("h2",me,[s(a(W),null,{default:n(()=>[s(a(ae))]),_:1}),e[5]||(e[5]=f(" 我的帖子 "))]),U.value?(i(),c("div",ge,[s(a(X),{rows:5,animated:""})])):_.value?(i(),x(a(H),{key:1,title:_.value,type:"error","show-icon":"",closable:!1},null,8,["title"])):(i(),c("div",fe,[u.value.length>0?(i(),c("div",ve,[(i(!0),c(O,null,Y(u.value,t=>(i(),c("div",{key:t.id,class:"post-card-item"},[s(ce,{post:t,"onUpdate:post":j},null,8,["post"]),w("div",ye,[s(a(k),{type:"primary",link:"",icon:a(le),onClick:r=>$(t)},{default:n(()=>e[6]||(e[6]=[f("编辑")])),_:2},1032,["icon","onClick"]),s(a(se),{title:"确定要删除这篇帖子吗？","confirm-button-text":"确定","cancel-button-text":"取消",onConfirm:r=>N(t.id)},{reference:n(()=>[s(a(k),{type:"danger",link:"",icon:a(oe)},{default:n(()=>e[7]||(e[7]=[f("删除")])),_:1},8,["icon"])]),_:2},1032,["onConfirm"])])]))),128))])):(i(),x(a(Z),{key:1,description:"你还没有发布任何帖子"})),!U.value&&!_.value&&d.total>d.pageSize?(i(),c("section",ke,[s(a(ee),{background:"",layout:"prev, pager, next",total:d.total,"page-size":d.pageSize,"current-page":d.currentPage,"onUpdate:currentPage":e[0]||(e[0]=t=>d.currentPage=t),onCurrentChange:L},null,8,["total","page-size","current-page"])])):S("",!0)])),s(a(te),{modelValue:E.value,"onUpdate:modelValue":e[4]||(e[4]=t=>E.value=t),title:"编辑帖子",width:"60%","close-on-click-modal":!1},{footer:n(()=>[w("span",Ue,[s(a(k),{onClick:e[3]||(e[3]=t=>E.value=!1)},{default:n(()=>e[11]||(e[11]=[f("取消")])),_:1}),s(a(k),{type:"primary",onClick:T,loading:h.value},{default:n(()=>e[12]||(e[12]=[f(" 保存 ")])),_:1},8,["loading"])])]),default:n(()=>[I.value?(i(),x(a(de),{key:0,model:o,"label-width":"80px",ref_key:"editFormRef",ref:P},{default:n(()=>[s(a(b),{label:"标题",prop:"title",rules:[{required:!0,message:"标题不能为空",trigger:"blur"}]},{default:n(()=>[s(a(z),{modelValue:o.title,"onUpdate:modelValue":e[1]||(e[1]=t=>o.title=t)},null,8,["modelValue"])]),_:1}),s(a(b),{label:"内容",prop:"content"},{default:n(()=>[s(a(z),{type:"textarea",rows:5,modelValue:o.content,"onUpdate:modelValue":e[2]||(e[2]=t=>o.content=t)},null,8,["modelValue"])]),_:1}),s(a(b),{label:"图片"},{default:n(()=>[o.imageUrl?(i(),c("div",_e,[s(a(re),{src:a(B)(o.imageUrl),fit:"contain",style:{width:"100px",height:"100px","margin-bottom":"10px",border:"1px solid #eee"},"preview-src-list":[a(B)(o.imageUrl)],"preview-teleported":"","hide-on-click-modal":""},null,8,["src","preview-src-list"]),s(a(k),{type:"danger",link:"",onClick:R},{default:n(()=>e[8]||(e[8]=[f("移除图片")])),_:1})])):(i(),x(a(ne),{key:1,class:"image-uploader",action:"","show-file-list":!1,"http-request":q,"before-upload":A,name:"postImage"},{tip:n(()=>e[10]||(e[10]=[w("div",{class:"el-upload__tip"}," 仅限jpg/png格式，大小不超过5MB ",-1)])),default:n(()=>[s(a(k),{type:"primary"},{default:n(()=>e[9]||(e[9]=[f("上传图片")])),_:1})]),_:1})),v.value?(i(),c("div",Ee,ie(v.value),1)):S("",!0)]),_:1})]),_:1},8,["model"])):S("",!0)]),_:1},8,["modelValue"])]))}}),be=ue(xe,[["__scopeId","data-v-d950a9f3"]]);export{be as default};
