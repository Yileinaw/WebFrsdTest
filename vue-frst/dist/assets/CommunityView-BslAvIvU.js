import{d as G,r as m,B as W,U as H,D as j,k as P,e as c,u as t,V as ie,o as u,b as o,W as q,N as Q,c as F,g as O,E as ve,Q as z,l as E,X as me,a as b,t as I,Y as pe,Z as h,P as S,_ as J,$ as X,s as Y,a0 as ae,h as le,a1 as oe,y as se,a2 as fe,x as ge,a3 as ye,F as re,v as ue,q as Z,a4 as ke,i as de,S as Ce,j as _e,a5 as we,a6 as he,a7 as be,a8 as Ue,a9 as ne,aa as Pe}from"./index-u3ChIZEC.js";import{S as Ee}from"./ShareCard-9IJNpXjv.js";import"./default-food-DJ8mVkvR.js";const Fe={key:0,class:"image-preview"},Le={key:2,style:{color:"red","font-size":"12px","margin-top":"5px"}},xe={class:"dialog-footer"},Ve=G({__name:"PostEditor",props:{visible:{type:Boolean}},emits:["update:visible","post-created"],setup(N,{emit:R}){const x=N,k=R,C=m(),p=W({title:"",content:""}),e=m(null),y=m(null),U=m(!1),f=m(null);H(),j(()=>x.visible,g=>{g&&L()});const $=W({title:[{required:!0,message:"请输入标题",trigger:"blur"}],content:[{required:!0,message:"请输入内容",trigger:"blur"}]}),L=()=>{var g;p.title="",p.content="",e.value=null,y.value=null,f.value=null,(g=C.value)==null||g.resetFields()},V=g=>{L(),k("update:visible",!1),g()},A=()=>{L(),k("update:visible",!1)},B=(g,d)=>{if(console.log("[PostEditor] handleFileChange triggered. File:",g.name,g.status),g.status==="ready"){const a=g.raw;if(!a){console.error("[PostEditor] No raw file found in uploadFile.");return}console.log("[PostEditor] Raw file details:",a.name,a.type,a.size);const i=a.type.startsWith("image/"),s=a.size/1024/1024<5;if(f.value=null,!i){console.log("[PostEditor] Validation Failed: Not an image."),h.error("请上传图片格式文件!");return}if(!s){console.log("[PostEditor] Validation Failed: Size limit exceeded."),h.error("图片大小不能超过 5MB!");return}console.log("[PostEditor] Validation Passed. Setting state..."),e.value=a,console.log("[PostEditor] selectedFile.value set:",e.value?e.value.name:"null");try{y.value&&URL.revokeObjectURL(y.value);const M=URL.createObjectURL(a);y.value=M,console.log("[PostEditor] imagePreviewUrl.value set:",y.value)}catch(M){console.error("[PostEditor] Error creating object URL:",M),f.value="生成图片预览失败",e.value=null,y.value=null}}else g.status==="fail"&&(console.error("[PostEditor] Upload file status failed:",g.name),h.error("文件选择失败，请重试"))},D=()=>{y.value&&URL.revokeObjectURL(y.value),e.value=null,y.value=null},T=async()=>{C.value&&await C.value.validate(async g=>{var d,a;if(g){U.value=!0;try{const i=new FormData;i.append("title",p.title),i.append("content",p.content),e.value&&i.append("image",e.value),await S.createPost(i),h.success("发布成功!"),k("post-created"),A()}catch(i){console.error("Failed to create post (Refactored):",i),h.error(((a=(d=i.response)==null?void 0:d.data)==null?void 0:a.message)||"发布失败")}finally{U.value=!1}}})};return(g,d)=>(u(),P(t(ie),{"model-value":g.visible,title:"发布新分享",width:"60%","onUpdate:modelValue":d[2]||(d[2]=a=>g.$emit("update:visible",a)),"close-on-click-modal":!1,"before-close":V,class:"post-editor-dialog"},{footer:c(()=>[b("span",xe,[o(t(z),{onClick:A},{default:c(()=>d[6]||(d[6]=[E("取消")])),_:1}),o(t(z),{type:"primary",onClick:T,loading:U.value},{default:c(()=>d[7]||(d[7]=[E(" 发布 ")])),_:1},8,["loading"])])]),default:c(()=>[o(t(pe),{ref_key:"postFormRef",ref:C,model:p,rules:$,"label-width":"80px"},{default:c(()=>[o(t(q),{label:"标题",prop:"title"},{default:c(()=>[o(t(Q),{modelValue:p.title,"onUpdate:modelValue":d[0]||(d[0]=a=>p.title=a),placeholder:"给你的分享起个响亮的标题吧"},null,8,["modelValue"])]),_:1}),o(t(q),{label:"内容",prop:"content"},{default:c(()=>[o(t(Q),{type:"textarea",rows:6,modelValue:p.content,"onUpdate:modelValue":d[1]||(d[1]=a=>p.content=a),placeholder:"分享你的美食故事、食谱或探店心得..."},null,8,["modelValue"])]),_:1}),o(t(q),{label:"图片"},{default:c(()=>[y.value?(u(),F("div",Fe,[o(t(ve),{src:y.value,fit:"contain",style:{width:"150px",height:"150px",border:"1px solid #eee"},"preview-src-list":[y.value],"preview-teleported":"","hide-on-click-modal":""},null,8,["src","preview-src-list"]),o(t(z),{type:"danger",link:"",onClick:D},{default:c(()=>d[3]||(d[3]=[E("移除图片")])),_:1})])):(u(),P(t(me),{key:1,class:"image-uploader",action:"","show-file-list":!1,onChange:B,accept:"image/*","auto-upload":!1},{tip:c(()=>d[5]||(d[5]=[b("div",{class:"el-upload__tip"}," 可选，仅限jpg/png格式，大小不超过5MB ",-1)])),default:c(()=>[o(t(z),{type:"primary"},{default:c(()=>d[4]||(d[4]=[E("选择图片")])),_:1})]),_:1})),f.value?(u(),F("div",Le,I(f.value),1)):O("",!0)]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["model-value"]))}}),Ie=J(Ve,[["__scopeId","data-v-cf921836"]]),Se={key:2,class:"modal-content"},ze={class:"post-header-modal"},Re={class:"username"},$e={class:"time"},Ae={class:"post-content-modal"},Be={class:"post-actions-modal"},De={class:"comments-section-modal",id:"comments-modal"},Me={key:0,class:"comment-input-area"},Te={key:1},Ne={key:4,class:"comment-list-modal"},je={class:"comment-header-modal"},Oe={class:"comment-author"},qe={class:"comment-time"},We={class:"comment-text-modal"},Qe={class:"dialog-footer"},Xe=G({__name:"PostDetailModal",props:{postId:{},visible:{type:Boolean}},emits:["update:visible","postUpdated"],setup(N,{emit:R}){const x=N,k=R;de(),Ce();const C=H(),p=m(!1),e=m(null),y=m(!1),U=m(null),f=m([]),$=m(!1),L=m(null),V=m(""),A=m(!1),B=m(!1),D=m(!1);j(()=>x.visible,n=>{p.value=n}),j(p,n=>{n||k("update:visible",!1)});const T=n=>n?new Date(n).toLocaleString():"未知时间",g=async()=>{var n,l;if(!x.postId){U.value="无效的帖子 ID",y.value=!1;return}y.value=!0,U.value=null,$.value=!0,L.value=null,f.value=[],V.value="";try{const v=await S.getPostById(x.postId);v&&v.post?(e.value=v.post,await d(x.postId)):(e.value=null,U.value="帖子数据加载失败或不存在。")}catch(v){console.error("Failed to fetch post details in modal:",v),U.value=((l=(n=v.response)==null?void 0:n.data)==null?void 0:l.message)||"加载帖子时发生错误",e.value=null}finally{y.value=!1}},d=async n=>{var l,v;$.value=!0,L.value=null;try{const r=await S.getCommentsByPostId(n);r&&Array.isArray(r)?f.value=r:r&&r.comments&&Array.isArray(r.comments)?f.value=r.comments:(f.value=[],console.warn("[PostDetailModal] Invalid or empty comments response structure:",r))}catch(r){console.error("Failed to fetch comments in modal:",r),L.value=((v=(l=r.response)==null?void 0:l.data)==null?void 0:v.message)||"加载评论时发生错误",f.value=[]}finally{$.value=!1}},a=()=>{k("update:visible",!1)},i=async()=>{var v,r;if(!e.value)return;if(!C.isLoggedIn){h.warning("请先登录");return}if(B.value)return;B.value=!0;const n=e.value.isLiked,l=e.value.likesCount||0;e.value.isLiked=!n,e.value.likesCount=n?l-1:l+1,k("postUpdated",e.value);try{n?await S.unlikePost(e.value.id):await S.likePost(e.value.id)}catch(w){console.error("Failed to update like status in modal:",w),h.error(((r=(v=w.response)==null?void 0:v.data)==null?void 0:r.message)||"点赞操作失败"),e.value&&(e.value.isLiked=n,e.value.likesCount=l,k("postUpdated",e.value))}finally{B.value=!1}},s=async()=>{var v,r;if(!e.value)return;if(!C.isLoggedIn){h.warning("请先登录");return}if(D.value)return;D.value=!0;const n=e.value.isFavorited,l=e.value.favoritesCount||0;e.value.isFavorited=!n,e.value.favoritesCount=n?l-1:l+1,k("postUpdated",e.value);try{n?await S.unfavoritePost(e.value.id):await S.favoritePost(e.value.id)}catch(w){console.error("Failed to update favorite status in modal:",w),h.error(((r=(v=w.response)==null?void 0:v.data)==null?void 0:r.message)||"收藏操作失败"),e.value&&(e.value.isFavorited=n,e.value.favoritesCount=l,k("postUpdated",e.value))}finally{D.value=!1}},M=async()=>{var n,l,v,r;if(!(!e.value||!V.value.trim())){if(!C.isLoggedIn){h.warning("请先登录再评论");return}A.value=!0;try{const w=await S.createComment(e.value.id,{text:V.value.trim()});if(w&&w.comment){const _={...w.comment,author:{id:((n=C.currentUser)==null?void 0:n.id)??0,name:((l=C.currentUser)==null?void 0:l.name)??"您"}};f.value.unshift(_),e.value.commentsCount!==void 0&&(e.value.commentsCount++,k("postUpdated",e.value)),V.value="",h.success("评论成功")}else h.error("评论失败，请重试")}catch(w){console.error("Failed to submit comment in modal:",w),h.error(((r=(v=w.response)==null?void 0:v.data)==null?void 0:r.message)||"发表评论失败")}finally{A.value=!1}}},ce=async n=>{var v,r,w;if(!e.value)return;const l=f.value.find(_=>_.id===n);if(!l||l.authorId!==((v=C.currentUser)==null?void 0:v.id)){h.warning("无法删除他人评论");return}try{await ke.confirm("确定要删除这条评论吗?","确认删除",{type:"warning"}),await S.deleteComment(n),f.value=f.value.filter(_=>_.id!==n),e.value.commentsCount!==void 0&&(e.value.commentsCount--,k("postUpdated",e.value)),h.success("评论已删除")}catch(_){_!=="cancel"&&(console.error("Failed to delete comment in modal:",_),h.error(((w=(r=_.response)==null?void 0:r.data)==null?void 0:w.message)||"删除评论失败"))}};return(n,l)=>{const v=ge("router-link");return u(),P(t(ie),{modelValue:p.value,"onUpdate:modelValue":l[1]||(l[1]=r=>p.value=r),title:e.value?e.value.title:"帖子详情",width:"70%","before-close":a,onOpened:g,class:"post-detail-modal","append-to-body":""},{footer:c(()=>[b("span",Qe,[o(t(z),{onClick:a},{default:c(()=>l[8]||(l[8]=[E("关闭")])),_:1})])]),default:c(()=>{var r,w;return[y.value?(u(),P(t(X),{key:0,rows:5,animated:""})):U.value?(u(),P(t(Y),{key:1,title:"加载帖子失败",type:"error",description:U.value,"show-icon":"",closable:!1},null,8,["description"])):e.value?(u(),F("div",Se,[b("div",ze,[o(t(le),{size:40,src:t(ae)((r=e.value.author)==null?void 0:r.avatarUrl)},null,8,["src"]),b("span",Re,I(((w=e.value.author)==null?void 0:w.name)||"匿名用户"),1),b("span",$e,I(T(e.value.createdAt)),1)]),b("p",Ae,I(e.value.content),1),b("div",Be,[o(t(z),{text:"",icon:e.value.isLiked?t(oe):t(se),type:e.value.isLiked?"primary":"",onClick:i,loading:B.value},{default:c(()=>[E(I(e.value.likesCount||0)+" 点赞 ",1)]),_:1},8,["icon","type","loading"]),o(t(z),{text:"",icon:e.value.isFavorited?t(oe):t(se),type:e.value.isFavorited?"warning":"",onClick:s,loading:D.value},{default:c(()=>[E(I(e.value.favoritesCount||0)+" 收藏 ",1)]),_:1},8,["icon","type","loading"]),b("span",null,I(e.value.commentsCount||0)+" 评论",1)]),o(t(fe)),b("div",De,[l[7]||(l[7]=b("h4",null,"评论",-1)),t(C).isLoggedIn?(u(),F("div",Me,[o(t(Q),{modelValue:V.value,"onUpdate:modelValue":l[0]||(l[0]=_=>V.value=_),type:"textarea",rows:2,placeholder:"添加评论...",maxlength:"500","show-word-limit":""},null,8,["modelValue"]),o(t(z),{type:"primary",onClick:M,loading:A.value,size:"small",style:{"margin-top":"8px"}},{default:c(()=>l[2]||(l[2]=[E(" 发表 ")])),_:1},8,["loading"])])):(u(),F("div",Te,[o(t(ye),{type:"info",size:"small"},{default:c(()=>[l[4]||(l[4]=E("请")),o(v,{to:{name:"Login",query:{redirect:n.$route.fullPath}}},{default:c(()=>l[3]||(l[3]=[E("登录")])),_:1},8,["to"]),l[5]||(l[5]=E("后发表评论"))]),_:1})])),$.value?(u(),P(t(X),{key:2,rows:3,animated:"",style:{"margin-top":"15px"}})):L.value?(u(),P(t(Y),{key:3,title:"加载评论失败",type:"error",description:L.value,"show-icon":"",closable:!1,size:"small",style:{"margin-top":"15px"}},null,8,["description"])):f.value.length>0?(u(),F("ul",Ne,[(u(!0),F(re,null,ue(f.value,_=>{var K,ee,te;return u(),F("li",{key:_.id,class:"comment-item-modal"},[b("div",je,[o(t(le),{size:24,src:t(ae)((K=_.author)==null?void 0:K.avatarUrl)},null,8,["src"]),b("span",Oe,I(((ee=_.author)==null?void 0:ee.name)||"匿名用户"),1),b("span",qe,I(T(_.createdAt)),1),((te=t(C).currentUser)==null?void 0:te.id)===_.authorId?(u(),P(t(z),{key:0,type:"danger",link:"",size:"small",onClick:lt=>ce(_.id),class:"delete-comment-btn"},{default:c(()=>l[6]||(l[6]=[E(" 删除 ")])),_:2},1032,["onClick"])):O("",!0)]),b("p",We,I(_.text),1)])}),128))])):(u(),P(t(Z),{key:5,description:"暂无评论","image-size":60}))])])):(u(),P(t(Z),{key:3,description:"帖子未找到","image-size":100}))]}),_:1},8,["modelValue","title"])}}}),Ye=J(Xe,[["__scopeId","data-v-411f84f9"]]),Ze={class:"community-view container"},Ge={class:"action-bar"},He={class:"posts-list-section"},Je={key:0,class:"loading-state"},Ke={key:2},et={key:0,class:"pagination-section"},tt={name:"CommunityView"},at=G({...tt,setup(N){const R=m("createdAt"),x=m(!1),k=m([]),C=m(!1),p=m(null),e=W({currentPage:1,pageSize:10,total:0}),y=m(null),U=m(!1),f=async(a=1,i="createdAt")=>{C.value=!0,p.value=null;try{const s=i==="popular"?"likesCount":i,M=await S.getAllPosts({page:a,limit:e.pageSize,sortBy:s});k.value=M.posts,e.total=M.totalCount||0,e.currentPage=a}catch(s){console.error("Failed to fetch posts:",s),p.value="加载帖子失败，请稍后再试。",h.error(p.value)}finally{C.value=!1}};j(R,a=>{f(1,a)});const $=a=>{console.log("Current page:",a),f(a,R.value)};_e(()=>{f(e.currentPage,R.value)});const L=H(),V=de(),A=()=>{if(!L.isLoggedIn){h.warning("请先登录再发布分享"),V.push("/login");return}console.log("Opening post editor..."),x.value=!0},B=()=>{console.log("Post created, refreshing list..."),f(1)},D=a=>{console.log("Liked post:",a)},T=a=>{console.log("Opening modal for post in CommunityView:",a),typeof a=="number"?(y.value=a,U.value=!0):console.error("Invalid postId received from ShareCard:",a)},g=a=>{console.log("Favorited post:",a)},d=a=>{const i=k.value.findIndex(s=>s.id===a.id);if(i!==-1){const s=k.value[i];s.title=a.title,s.content=a.content??null,s.imageUrl=a.imageUrl??null,s.likesCount=a.likesCount,s.commentsCount=a.commentsCount,s.favoritesCount=a.favoritesCount,s.isLiked=a.isLiked,s.isFavorited=a.isFavorited,k.value[i]=s}};return(a,i)=>(u(),F("div",Ze,[b("section",Ge,[o(t(we),{modelValue:R.value,"onUpdate:modelValue":i[0]||(i[0]=s=>R.value=s),class:"tabs"},{default:c(()=>[o(t(ne),{label:"最新发布",name:"createdAt"}),o(t(ne),{label:"热门讨论",name:"popular"})]),_:1},8,["modelValue"]),o(t(z),{type:"primary",icon:t(he),onClick:A},{default:c(()=>i[4]||(i[4]=[E("发布分享")])),_:1},8,["icon"])]),b("section",He,[C.value?(u(),F("div",Je,[o(t(X),{rows:10,animated:""})])):p.value?(u(),P(t(Y),{key:1,title:p.value,type:"error","show-icon":"",closable:!1},null,8,["title"])):(u(),F("div",Ke,[o(t(be),{gutter:20},{default:c(()=>[(u(!0),F(re,null,ue(k.value,s=>(u(),P(t(Pe),{span:24,key:s.id},{default:c(()=>[o(Ee,{post:s,onLike:D,onComment:T,onFavorite:g,"onUpdate:post":d},null,8,["post"])]),_:2},1024))),128))]),_:1}),!C.value&&!p.value&&k.value.length===0?(u(),P(t(Z),{key:0,description:"社区还没有分享，快来发布第一条吧！"})):O("",!0)]))]),!C.value&&!p.value&&e.total>e.pageSize?(u(),F("section",et,[o(t(Ue),{background:"",layout:"prev, pager, next",total:e.total,"page-size":e.pageSize,"current-page":e.currentPage,"onUpdate:currentPage":i[1]||(i[1]=s=>e.currentPage=s),onCurrentChange:$},null,8,["total","page-size","current-page"])])):O("",!0),o(Ie,{visible:x.value,"onUpdate:visible":i[2]||(i[2]=s=>x.value=s),onPostCreated:B},null,8,["visible"]),o(Ye,{"post-id":y.value,visible:U.value,"onUpdate:visible":i[3]||(i[3]=s=>U.value=s),onPostUpdated:d},null,8,["post-id","visible"])]))}}),it=J(at,[["__scopeId","data-v-62053c5a"]]);export{it as default};
