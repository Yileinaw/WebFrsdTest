import{d as K,r as A,B as j,C as q,j as H,c as u,a as d,k,b as c,l as x,e as f,u as n,f as M,Q as E,av as Q,$ as Z,s as G,g as C,F as J,v as W,q as X,a8 as Y,aw as h,o as l,ax as N,n as ee,ay as te,a0 as ae,h as se,t as y,I as b,az as ne,aA as T,ao as oe,y as re,am as le,al as ce,Z as p,a4 as ie,i as ue,_ as de}from"./index-u3ChIZEC.js";const pe={class:"notifications-view"},fe={class:"header"},me={class:"actions"},ge={key:0,class:"loading-state"},_e={key:2},ve={key:0,class:"notification-list"},he=["onClick"],ye={key:0,class:"unread-indicator"},ke={class:"content"},Ee={class:"actor-name"},Ce={class:"action-text"},we={class:"post-title"},Ae={key:0,class:"comment-preview"},xe={class:"meta"},Me={class:"time"},Ne={key:2,class:"pagination-section"},be=K({__name:"NotificationsView",setup(Te){const i=A([]),m=A(!0),_=A(null),o=j({currentPage:1,pageSize:15,total:0}),R=ue(),z=q(()=>i.value.filter(t=>!t.isRead).length),w=async(t=1)=>{var a,e;m.value=!0,_.value=null;try{const s=await h.getNotifications({page:t,limit:o.pageSize});i.value=s.notifications.map(r=>({...r,sender:r.sender||{id:-1,name:"未知用户",avatarUrl:"",email:"",createdAt:"",updatedAt:""},post:r.post||{id:-1,title:"未知帖子"},comment:r.comment})),o.total=s.totalCount||0,o.currentPage=t}catch(s){console.error("Error fetching notifications:",s),_.value=((e=(a=s.response)==null?void 0:a.data)==null?void 0:e.message)||"加载通知列表失败",i.value=[],o.total=0}finally{m.value=!1}},P=t=>{switch(t){case"LIKE":return ce;case"COMMENT":return le;case"FAVORITE":return re;default:return N}},$=t=>{switch(t){case"LIKE":return"点赞了你的帖子";case"COMMENT":return"评论了你的帖子";case"FAVORITE":return"收藏了你的帖子";default:return"与你的帖子进行了互动"}},B=t=>{if(!t)return"未知时间";const a=new Date(t),s=Math.floor((new Date().getTime()-a.getTime())/1e3),r=Math.floor(s/60),g=Math.floor(r/60),v=Math.floor(g/24);return s<60?"刚刚":r<60?`${r}分钟前`:g<24?`${g}小时前`:v<7?`${v}天前`:a.toLocaleDateString()},S=(t="",a)=>t.length>a?t.substring(0,a)+"...":t,V=t=>{w(t)},D=async t=>{var a,e;try{await h.markAsRead(t);const s=i.value.findIndex(r=>r.id===t);s!==-1&&(i.value[s].isRead=!0)}catch(s){console.error("Error marking notification as read:",s),p.error(((e=(a=s.response)==null?void 0:a.data)==null?void 0:e.message)||"操作失败")}},I=async()=>{var t,a;try{const e=await h.markAllAsRead();i.value.forEach(s=>s.isRead=!0),p.success(`已将 ${e.count} 条未读通知标记为已读`)}catch(e){console.error("Error marking all notifications as read:",e),p.error(((a=(t=e.response)==null?void 0:t.data)==null?void 0:a.message)||"操作失败")}},O=t=>{ie.confirm("确定要删除这条通知吗?","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{L(t)}).catch(()=>{})},L=async t=>{var a,e;try{await h.deleteNotification(t),w(o.currentPage),p.success("通知已删除")}catch(s){console.error("Error deleting notification:",s),p.error(((e=(a=s.response)==null?void 0:a.data)==null?void 0:e.message)||"删除失败")}},F=async()=>{var t,a;try{const e=await h.clearAllNotifications();i.value=[],o.total=0,o.currentPage=1,p.success(`已清空 ${e.count} 条通知`)}catch(e){console.error("Error clearing notifications:",e),p.error(((a=(t=e.response)==null?void 0:t.data)==null?void 0:a.message)||"清空失败")}},U=t=>{if(t==null||t===-1){p.warning("关联的帖子不存在或已被删除");return}R.push(`/posts/${t}`)};return H(()=>{w(o.currentPage)}),(t,a)=>(l(),u("div",pe,[d("div",fe,[d("h2",null,[c(n(M),null,{default:f(()=>[c(n(N))]),_:1}),a[1]||(a[1]=x(" 消息通知 "))]),d("div",me,[c(n(E),{type:"primary",link:"",onClick:I,disabled:z.value===0||m.value},{default:f(()=>a[2]||(a[2]=[x("全部标记为已读")])),_:1},8,["disabled"]),c(n(Q),{title:"确定要清空所有通知吗？","confirm-button-text":"确定","cancel-button-text":"取消",onConfirm:F},{reference:f(()=>[c(n(E),{type:"danger",link:"",disabled:i.value.length===0||m.value},{default:f(()=>a[3]||(a[3]=[x("清空通知")])),_:1},8,["disabled"])]),_:1})])]),m.value?(l(),u("div",ge,[c(n(Z),{rows:5,animated:""})])):_.value?(l(),k(n(G),{key:1,title:_.value,type:"error","show-icon":"",closable:!1},null,8,["title"])):(l(),u("div",_e,[i.value.length>0?(l(),u("div",ve,[(l(!0),u(J,null,W(i.value,e=>{var s,r,g;return l(),u("div",{key:e.id,class:ee(["notification-item",{unread:!e.isRead}]),onClick:v=>U(e.postId)},[e.isRead?C("",!0):(l(),u("span",ye)),c(n(M),{class:"type-icon",size:20},{default:f(()=>[(l(),k(te(P(e.type))))]),_:2},1024),c(n(se),{size:36,src:n(ae)((s=e.sender)==null?void 0:s.avatarUrl),class:"actor-avatar"},null,8,["src"]),d("div",ke,[d("span",Ee,y(((r=e.sender)==null?void 0:r.name)||"未知用户"),1),d("span",Ce,y($(e.type)),1),d("span",we,"《"+y(((g=e.post)==null?void 0:g.title)||"帖子")+"》",1),e.type==="COMMENT"&&e.comment?(l(),u("span",Ae,': "'+y(S(e.comment.text,30))+'"',1)):C("",!0)]),d("div",xe,[d("span",Me,y(B(e.createdAt)),1),e.isRead?C("",!0):(l(),k(n(T),{key:0,content:"标记已读",placement:"top"},{default:f(()=>[c(n(E),{type:"success",circle:"",size:"small",icon:n(ne),onClick:b(v=>D(e.id),["stop"]),class:"action-button"},null,8,["icon","onClick"])]),_:2},1024)),c(n(T),{content:"删除通知",placement:"top"},{default:f(()=>[c(n(E),{type:"danger",circle:"",size:"small",icon:n(oe),onClick:b(v=>O(e.id),["stop"]),class:"action-button"},null,8,["icon","onClick"])]),_:2},1024)])],10,he)}),128))])):(l(),k(n(X),{key:1,description:"暂无通知"})),!m.value&&!_.value&&o.total>o.pageSize?(l(),u("section",Ne,[c(n(Y),{background:"",layout:"prev, pager, next",total:o.total,"page-size":o.pageSize,"current-page":o.currentPage,"onUpdate:currentPage":a[0]||(a[0]=e=>o.currentPage=e),onCurrentChange:V},null,8,["total","page-size","current-page"])])):C("",!0)]))]))}}),ze=de(be,[["__scopeId","data-v-9a6cebf4"]]);export{ze as default};
