import{d as W,N as G,a8 as J,r as i,X as Q,o as X,A as u,M as $,G as k,y as c,a as r,w as o,u as l,h as b,b as H,l as Y,c as y,e as R,ak as Z,v as ee,T as C,a9 as te,q as m,f as F,ai as I,I as ae,aj as le,J as se,at as oe,t as j,Q as re,S as ne,p as ie,g as ue,a4 as de,D as d,_ as ve}from"./index-B8L1PXQk.js";const pe={class:"edit-post-view"},ce={class:"page-header"},me={class:"container"},ge={class:"header-content"},fe={class:"actions"},we={class:"container"},ye={class:"post-editor-container"},_e={key:0,class:"image-preview"},ke={key:2,class:"upload-error"},be=W({__name:"EditPostView",setup(Ue){const U=$(),S=J(),P=G(),B=Number(S.params.id),V=i(),a=i(null),g=i(null),n=i(null),h=i(null),v=i([]),E=i(!1),f=i(""),D=i(),x=i(!1),_=i(!0),M=Q({title:[{required:!0,message:"请输入标题",trigger:"blur"},{min:1,max:100,message:"标题长度应在1-100个字符之间",trigger:"blur"}],content:[{required:!0,message:"请输入内容",trigger:"blur"},{min:1,max:5e3,message:"内容长度应在1-5000个字符之间",trigger:"blur"}]}),L=()=>{U.back()},T=async()=>{var s,e,p;_.value=!0;try{const t=await C.getPostById(B);if(t.post.authorId!==((s=P.currentUser)==null?void 0:s.id)){u.error("您没有权限编辑此帖子"),a.value=null;return}a.value={id:t.post.id,title:t.post.title,content:t.post.content??"",imageUrl:t.post.imageUrl},t.post.imageUrl&&(n.value=te(t.post.imageUrl)),t.post.tags&&Array.isArray(t.post.tags)&&(v.value=t.post.tags.map(w=>w.name))}catch(t){console.error("Failed to load post:",t),u.error(((p=(e=t.response)==null?void 0:e.data)==null?void 0:p.message)||"加载帖子失败"),a.value=null}finally{_.value=!1}},A=s=>{if(s.status==="ready"){const e=s.raw;if(!e){console.error("No raw file found in uploadFile.");return}const p=e.type.startsWith("image/"),t=e.size/1024/1024<5;if(h.value=null,!p){u.error("请上传图片格式文件!");return}if(!t){u.error("图片大小不能超过 5MB!");return}g.value=e;try{n.value&&URL.revokeObjectURL(n.value);const w=URL.createObjectURL(e);n.value=w}catch(w){console.error("Error creating object URL:",w),h.value="生成图片预览失败",g.value=null,n.value=null}}else s.status==="fail"&&u.error("文件选择失败，请重试")},q=()=>{n.value&&g.value&&URL.revokeObjectURL(n.value),g.value=null,n.value=null,a.value&&(a.value.imageUrl=null)},z=()=>{E.value=!0,de(()=>{var s,e;(e=(s=D.value)==null?void 0:s.input)==null||e.focus()})},N=()=>{f.value&&(v.value.length>=5?u.warning("最多添加5个标签"):v.value.includes(f.value)?u.warning("标签已存在"):v.value.push(f.value)),E.value=!1,f.value=""},O=s=>{v.value=v.value.filter(e=>e!==s)},K=async()=>{var s,e;if(!(!V.value||!a.value))try{if(!await V.value.validate())return;if(x.value=!0,g.value){const t=new FormData;t.append("title",a.value.title),t.append("content",a.value.content),t.append("image",g.value),v.value.length>0&&t.append("tags",v.value.join(",")),await C.updatePostWithImage(a.value.id,t)}else{const t={title:a.value.title,content:a.value.content,imageUrl:a.value.imageUrl,tagNames:v.value};await C.updatePost(a.value.id,t)}u.success("更新成功!"),U.push({name:"PostDetail",params:{id:a.value.id}})}catch(p){console.error("Failed to update post:",p),u.error(((e=(s=p.response)==null?void 0:s.data)==null?void 0:e.message)||"更新失败")}finally{x.value=!1}};return X(()=>{if(!P.isLoggedIn){u.warning("请先登录"),U.push("/login");return}if(isNaN(B)){u.error("无效的帖子ID"),U.push("/");return}T()}),(s,e)=>{const p=Y("loading");return d(),k("div",pe,[c("div",ce,[c("div",me,[c("div",ge,[e[5]||(e[5]=c("h1",null,"编辑帖子",-1)),c("div",fe,[r(l(b),{onClick:L},{default:o(()=>e[3]||(e[3]=[m("取消")])),_:1}),r(l(b),{type:"primary",onClick:K,loading:x.value},{default:o(()=>e[4]||(e[4]=[m("保存")])),_:1},8,["loading"])])])])]),c("div",we,[H((d(),k("div",ye,[!_.value&&a.value?(d(),y(l(Z),{key:0,ref_key:"postFormRef",ref:V,model:a.value,rules:M,"label-position":"top",class:"post-form"},{default:o(()=>[r(l(I),{label:"标题",prop:"title"},{default:o(()=>[r(l(F),{modelValue:a.value.title,"onUpdate:modelValue":e[0]||(e[0]=t=>a.value.title=t),placeholder:"给你的分享起个响亮的标题吧",maxlength:"100","show-word-limit":""},null,8,["modelValue"])]),_:1}),r(l(I),{label:"内容",prop:"content"},{default:o(()=>[r(l(F),{type:"textarea",rows:10,modelValue:a.value.content,"onUpdate:modelValue":e[1]||(e[1]=t=>a.value.content=t),placeholder:"分享你的美食故事、食谱或探店心得...",maxlength:"5000","show-word-limit":""},null,8,["modelValue"])]),_:1}),r(l(I),{label:"封面图片"},{default:o(()=>[n.value?(d(),k("div",_e,[r(l(ae),{src:n.value,fit:"contain",style:{width:"100%","max-height":"300px",border:"1px solid #eee"},"preview-src-list":[n.value],"preview-teleported":"","hide-on-click-modal":""},null,8,["src","preview-src-list"]),r(l(b),{type:"danger",onClick:q},{default:o(()=>e[6]||(e[6]=[m("移除图片")])),_:1})])):(d(),y(l(le),{key:1,class:"image-uploader",action:"","show-file-list":!1,onChange:A,accept:"image/*","auto-upload":!1,drag:""},{tip:o(()=>e[7]||(e[7]=[c("div",{class:"el-upload__tip"}," 可选，仅限jpg/png格式，大小不超过5MB ",-1)])),default:o(()=>[r(l(se),{class:"el-icon--upload"},{default:o(()=>[r(l(oe))]),_:1}),e[8]||(e[8]=c("div",{class:"el-upload__text"},[m("拖拽图片到此处，或 "),c("em",null,"点击上传")],-1))]),_:1})),h.value?(d(),k("div",ke,j(h.value),1)):R("",!0)]),_:1}),r(l(I),{label:"标签"},{default:o(()=>[(d(!0),k(re,null,ne(v.value,t=>(d(),y(l(ie),{key:t,closable:"",onClose:w=>O(t),class:"tag-item"},{default:o(()=>[m(j(t),1)]),_:2},1032,["onClose"]))),128)),E.value?(d(),y(l(F),{key:0,ref_key:"tagInputRef",ref:D,modelValue:f.value,"onUpdate:modelValue":e[2]||(e[2]=t=>f.value=t),class:"tag-input",size:"small",onKeyup:ue(N,["enter"]),onBlur:N},null,8,["modelValue"])):(d(),y(l(b),{key:1,class:"button-new-tag",size:"small",onClick:z},{default:o(()=>e[9]||(e[9]=[m(" + 添加标签 ")])),_:1})),e[10]||(e[10]=c("div",{class:"tag-tip"},"添加标签可以让更多人发现你的帖子",-1))]),_:1})]),_:1},8,["model","rules"])):R("",!0),!_.value&&!a.value?(d(),y(l(ee),{key:1,description:"找不到帖子或无权编辑"},{default:o(()=>[r(l(b),{type:"primary",onClick:L},{default:o(()=>e[11]||(e[11]=[m("返回")])),_:1})]),_:1})):R("",!0)])),[[p,_.value]])])])}}}),Ie=ve(be,[["__scopeId","data-v-be6f3706"]]);export{Ie as default};
