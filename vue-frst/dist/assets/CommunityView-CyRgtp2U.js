import{d as se,N as le,r as h,G as _,H as ne,e as O,y as i,a,u as e,I as Pe,a9 as ee,w as s,q as T,J as X,K as _e,L as ce,t as I,Q as K,S as Q,c as S,p as ye,U as pe,aa as Ue,ab as Le,ac as $e,h as j,ad as Ve,ae as Ie,af as Ce,M as he,A as b,T as B,D as l,_ as oe,X as ve,o as xe,Z as te,ag as Fe,ah as Se,ai as Z,f as ae,i as ze,j as Te,aj as Ae,ak as De,a7 as me,P as fe,al as we,am as Be,an as Ee,ao as Me,v as ge,C as Re,a8 as je,Y as ie,ap as Ne,aq as Oe,g as qe,ar as Ke,k as re,x as Qe,a5 as We,as as ue,s as Ge,E as de}from"./index-B8L1PXQk.js";import{_ as He}from"./default-food-DJ8mVkvR.js";import{f as Je,t as Xe}from"./formatters-Ce3ZkgnQ.js";import{P as Ye}from"./PostTagService-CUB2YNF0.js";const Ze={key:0,class:"card-cover"},et={class:"image-placeholder"},tt={class:"image-placeholder"},at={class:"card-content"},st={class:"author-info"},lt={class:"author-details"},ot={class:"post-time"},nt={class:"post-body"},it={key:0,class:"post-tags"},rt={key:0,class:"more-tags"},ut={class:"post-stats"},dt=se({__name:"EnhancedShareCard",props:{post:{},isFeatured:{type:Boolean}},emits:["like","comment","favorite","update:post"],setup(W,{emit:q}){const u=W,E=q,z=he(),d=le(),t=h(!1),C=h(!1),L=()=>{z.push({name:"PostDetail",params:{id:u.post.id}})},p=()=>{var r;(r=u.post.author)!=null&&r.id&&z.push({name:"UserProfile",params:{id:u.post.author.id}})},N=async()=>{var r,v;if(!d.isLoggedIn){b.warning("请先登录再点赞");return}if(!t.value){t.value=!0;try{const k=u.post.isLiked||!1,P=u.post.likesCount||0,R={...u.post,isLiked:!k,likesCount:k?Math.max(0,P-1):P+1};E("update:post",R),k?await B.unlikePost(u.post.id):await B.likePost(u.post.id),E("like",u.post.id)}catch(k){console.error("Toggle like error:",k),b.error(((v=(r=k.response)==null?void 0:r.data)==null?void 0:v.message)||"操作失败");const P={...u.post,isLiked:u.post.isLiked||!1,likesCount:u.post.likesCount||0};E("update:post",P)}finally{t.value=!1}}},M=async()=>{var r,v;if(!d.isLoggedIn){b.warning("请先登录再收藏");return}if(!C.value){C.value=!0;try{const k=u.post.isFavorited||!1,P=u.post.favoritesCount||0,R={...u.post,isFavorited:!k,favoritesCount:k?Math.max(0,P-1):P+1};E("update:post",R),k?await B.unfavoritePost(u.post.id):await B.favoritePost(u.post.id),E("favorite",u.post.id)}catch(k){console.error("Toggle favorite error:",k),b.error(((v=(r=k.response)==null?void 0:r.data)==null?void 0:v.message)||"操作失败");const P={...u.post,isFavorited:u.post.isFavorited||!1,favoritesCount:u.post.favoritesCount||0};E("update:post",P)}finally{C.value=!1}}},D=r=>{switch(r){case"share":b.info("分享功能开发中...");break;case"report":b.info("举报功能开发中...");break}};return(r,v)=>{var k,P;return l(),_("div",{class:ne(["enhanced-share-card",{"has-image":!!r.post.imageUrl,"is-featured":r.isFeatured}]),onClick:L},[r.post.imageUrl?(l(),_("div",Ze,[a(e(Pe),{src:e(ee)(r.post.imageUrl),fit:"cover",class:"cover-image",lazy:"",onClick:L},{placeholder:s(()=>[i("div",et,[a(e(X),{size:30},{default:s(()=>[a(e(_e))]),_:1})])]),error:s(()=>[i("div",tt,[a(e(X),{size:30},{default:s(()=>[a(e(_e))]),_:1}),v[0]||(v[0]=T()),v[1]||(v[1]=i("span",null,"加载失败",-1))])]),_:1},8,["src"])])):O("",!0),i("div",at,[i("div",st,[a(e(ce),{size:32,src:e(ee)(((k=r.post.author)==null?void 0:k.avatarUrl)||""),onError:R=>!0,onClick:p,class:"author-avatar"},{default:s(()=>v[2]||(v[2]=[i("img",{src:He},null,-1)])),_:1},8,["src"]),i("div",lt,[i("span",{class:"author-name",onClick:p},I(((P=r.post.author)==null?void 0:P.name)||"匿名用户"),1),i("span",ot,I(e(Je)(r.post.createdAt)),1)])]),i("div",nt,[i("h3",{class:"post-title",onClick:L},I(r.post.title),1),r.post.content?(l(),_("p",{key:0,class:"post-text",onClick:L},I(e(Xe)(r.post.content,120)),1)):O("",!0)]),r.post.tags&&r.post.tags.length?(l(),_("div",it,[(l(!0),_(K,null,Q(r.post.tags.slice(0,3),R=>(l(),S(e(ye),{size:"small",key:R.id,type:"info",class:"tag-item"},{default:s(()=>[T(I(R.name),1)]),_:2},1024))),128)),r.post.tags.length>3?(l(),_("span",rt,"+"+I(r.post.tags.length-3),1)):O("",!0)])):O("",!0),i("div",ut,[i("div",{class:ne(["stat-item",{"is-active":r.post.isLiked}]),onClick:N},[a(e(X),null,{default:s(()=>[a(e(pe))]),_:1}),i("span",null,I(r.post.likesCount||0),1)],2),i("div",{class:"stat-item",onClick:L},[a(e(X),null,{default:s(()=>[a(e(Ue))]),_:1}),i("span",null,I(r.post.commentsCount||0),1)]),i("div",{class:ne(["stat-item",{"is-active":r.post.isFavorited}]),onClick:M},[a(e(X),null,{default:s(()=>[a(e(Le))]),_:1}),i("span",null,I(r.post.favoritesCount||0),1)],2),a(e($e),{trigger:"click",class:"more-actions",onCommand:D},{dropdown:s(()=>[a(e(Ie),null,{default:s(()=>[a(e(Ce),{command:"share"},{default:s(()=>v[3]||(v[3]=[T("分享")])),_:1}),a(e(Ce),{command:"report",divided:""},{default:s(()=>v[4]||(v[4]=[T("举报")])),_:1})]),_:1})]),default:s(()=>[a(e(j),{type:"text",class:"more-btn"},{default:s(()=>[a(e(X),null,{default:s(()=>[a(e(Ve))]),_:1})]),_:1})]),_:1})])])],2)}}}),be=oe(dt,[["__scopeId","data-v-e886159c"]]),ct={key:1,style:{"font-size":"12px",color:"#909399","margin-left":"10px","vertical-align":"top"}},pt={key:0,class:"image-preview"},vt={key:2,style:{color:"red","font-size":"12px","margin-top":"5px"}},mt={class:"dialog-footer"},ft=se({__name:"PostEditor",props:{visible:{type:Boolean}},emits:["update:visible","post-created"],setup(W,{emit:q}){const u=W,E=q,z=h(),d=ve({title:"",content:"",tags:[]}),t=h(null),C=h(null),L=h(!1),p=h(null);le();const N=h([]),M=async()=>{try{const g=await Se.get("/tags");N.value=g.data.tags||[]}catch(g){console.error("Failed to fetch available tags:",g),b.error("获取标签列表失败")}};xe(()=>{M()}),te(()=>u.visible,g=>{g&&(r(),M())});const D=ve({title:[{required:!0,message:"请输入标题",trigger:"blur"}],content:[{required:!0,message:"请输入内容",trigger:"blur"}]}),r=()=>{var g;d.title="",d.content="",d.tags=[],t.value=null,C.value=null,p.value=null,(g=z.value)==null||g.resetFields()},v=g=>{r(),E("update:visible",!1),g()},k=()=>{r(),E("update:visible",!1)},P=(g,w)=>{if(console.log("[PostEditor] handleFileChange triggered. File:",g.name,g.status),g.status==="ready"){const m=g.raw;if(!m){console.error("[PostEditor] No raw file found in uploadFile.");return}console.log("[PostEditor] Raw file details:",m.name,m.type,m.size);const A=m.type.startsWith("image/"),c=m.size/1024/1024<5;if(p.value=null,!A){console.log("[PostEditor] Validation Failed: Not an image."),b.error("请上传图片格式文件!");return}if(!c){console.log("[PostEditor] Validation Failed: Size limit exceeded."),b.error("图片大小不能超过 5MB!");return}console.log("[PostEditor] Validation Passed. Setting state..."),t.value=m,console.log("[PostEditor] selectedFile.value set:",t.value?t.value.name:"null");try{C.value&&URL.revokeObjectURL(C.value);const o=URL.createObjectURL(m);C.value=o,console.log("[PostEditor] imagePreviewUrl.value set:",C.value)}catch(o){console.error("[PostEditor] Error creating object URL:",o),p.value="生成图片预览失败",t.value=null,C.value=null}}else g.status==="fail"&&(console.error("[PostEditor] Upload file status failed:",g.name),b.error("文件选择失败，请重试"))},R=()=>{C.value&&URL.revokeObjectURL(C.value),t.value=null,C.value=null},Y=async()=>{z.value&&await z.value.validate(async g=>{var w,m;if(g){L.value=!0;try{const A=new FormData;A.append("title",d.title),A.append("content",d.content),d.tags.length>0&&d.tags.forEach(c=>{A.append("tags",c)}),t.value&&A.append("image",t.value),await B.createPost(A),b.success("发布成功!"),E("post-created"),k()}catch(A){console.error("Failed to create post (Refactored):",A),b.error(((m=(w=A.response)==null?void 0:w.data)==null?void 0:m.message)||"发布失败")}finally{L.value=!1}}})},G=g=>{d.tags.splice(d.tags.indexOf(g),1)};return(g,w)=>(l(),S(e(Fe),{"model-value":g.visible,title:"发布新分享",width:"60%","onUpdate:modelValue":w[3]||(w[3]=m=>g.$emit("update:visible",m)),"close-on-click-modal":!1,"before-close":v,class:"post-editor-dialog"},{footer:s(()=>[i("span",mt,[a(e(j),{onClick:k},{default:s(()=>w[7]||(w[7]=[T("取消")])),_:1}),a(e(j),{type:"primary",onClick:Y,loading:L.value},{default:s(()=>w[8]||(w[8]=[T(" 发布 ")])),_:1},8,["loading"])])]),default:s(()=>[a(e(De),{ref_key:"postFormRef",ref:z,model:d,rules:D,"label-width":"80px"},{default:s(()=>[a(e(Z),{label:"标题",prop:"title"},{default:s(()=>[a(e(ae),{modelValue:d.title,"onUpdate:modelValue":w[0]||(w[0]=m=>d.title=m),placeholder:"给你的分享起个响亮的标题吧"},null,8,["modelValue"])]),_:1}),a(e(Z),{label:"内容",prop:"content"},{default:s(()=>[a(e(ae),{type:"textarea",rows:6,modelValue:d.content,"onUpdate:modelValue":w[1]||(w[1]=m=>d.content=m),placeholder:"分享你的美食故事、食谱或探店心得..."},null,8,["modelValue"])]),_:1}),a(e(Z),{label:"标签"},{default:s(()=>[(l(!0),_(K,null,Q(d.tags,m=>(l(),S(e(ye),{key:m,closable:"","disable-transitions":!1,onClose:A=>G(m),style:{"margin-right":"5px","margin-bottom":"5px"}},{default:s(()=>[T(I(m),1)]),_:2},1032,["onClose"]))),128)),d.tags.length<5?(l(),S(e(ze),{key:0,modelValue:d.tags,"onUpdate:modelValue":w[2]||(w[2]=m=>d.tags=m),multiple:"",filterable:"","allow-create":"","default-first-option":"",placeholder:"选择或创建标签 (最多5个)",size:"small",style:{width:"240px","margin-left":"10px","vertical-align":"top"},class:"tag-select"},{default:s(()=>[(l(!0),_(K,null,Q(N.value,m=>(l(),S(e(Te),{key:m.id,label:m.name,value:m.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])):(l(),_("span",ct,"最多添加5个标签"))]),_:1}),a(e(Z),{label:"图片"},{default:s(()=>[C.value?(l(),_("div",pt,[a(e(Pe),{src:C.value,fit:"contain",style:{width:"150px",height:"150px",border:"1px solid #eee"},"preview-src-list":[C.value],"preview-teleported":"","hide-on-click-modal":""},null,8,["src","preview-src-list"]),a(e(j),{type:"danger",link:"",onClick:R},{default:s(()=>w[4]||(w[4]=[T("移除图片")])),_:1})])):(l(),S(e(Ae),{key:1,class:"image-uploader",action:"","show-file-list":!1,onChange:P,accept:"image/*","auto-upload":!1},{tip:s(()=>w[6]||(w[6]=[i("div",{class:"el-upload__tip"}," 可选，仅限jpg/png格式，大小不超过5MB ",-1)])),default:s(()=>[a(e(j),{type:"primary"},{default:s(()=>w[5]||(w[5]=[T("选择图片")])),_:1})]),_:1})),p.value?(l(),_("div",vt,I(p.value),1)):O("",!0)]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["model-value"]))}}),gt=oe(ft,[["__scopeId","data-v-ceefbc23"]]),yt={key:2,class:"modal-content"},ht={class:"post-header-modal"},kt={class:"username"},_t={class:"time"},Ct={class:"post-content-modal"},wt={class:"post-actions-modal"},bt={class:"comments-section-modal",id:"comments-modal"},Pt={key:0,class:"comment-input-area"},xt={key:1},Ft={key:4,class:"comment-list-modal"},Et={class:"comment-header-modal"},Ut={class:"comment-author"},Lt={class:"comment-time"},$t={class:"comment-text-modal"},Vt={class:"dialog-footer"},It=se({__name:"PostDetailModal",props:{postId:{},visible:{type:Boolean}},emits:["update:visible","postUpdated"],setup(W,{emit:q}){const u=W,E=q;he(),je();const z=le(),d=h(!1),t=h(null),C=h(!1),L=h(null),p=h([]),N=h(!1),M=h(null),D=h(""),r=h(!1),v=h(!1),k=h(!1);te(()=>u.visible,c=>{d.value=c}),te(d,c=>{c||E("update:visible",!1)});const P=c=>c?new Date(c).toLocaleString():"未知时间",R=async()=>{var c,o;if(!u.postId){L.value="无效的帖子 ID",C.value=!1;return}C.value=!0,L.value=null,N.value=!0,M.value=null,p.value=[],D.value="";try{const x=await B.getPostById(u.postId);x&&x.post?(t.value=x.post,await Y(u.postId)):(t.value=null,L.value="帖子数据加载失败或不存在。")}catch(x){console.error("Failed to fetch post details in modal:",x),L.value=((o=(c=x.response)==null?void 0:c.data)==null?void 0:o.message)||"加载帖子时发生错误",t.value=null}finally{C.value=!1}},Y=async c=>{var o,x;N.value=!0,M.value=null;try{const f=await B.getCommentsByPostId(c);f&&Array.isArray(f)?p.value=f:f&&f.comments&&Array.isArray(f.comments)?p.value=f.comments:(p.value=[],console.warn("[PostDetailModal] Invalid or empty comments response structure:",f))}catch(f){console.error("Failed to fetch comments in modal:",f),M.value=((x=(o=f.response)==null?void 0:o.data)==null?void 0:x.message)||"加载评论时发生错误",p.value=[]}finally{N.value=!1}},G=()=>{E("update:visible",!1)},g=async()=>{var x,f;if(!t.value)return;if(!z.isLoggedIn){b.warning("请先登录");return}if(v.value)return;v.value=!0;const c=t.value.isLiked,o=t.value.likesCount||0;t.value.isLiked=!c,t.value.likesCount=c?o-1:o+1,E("postUpdated",t.value);try{c?await B.unlikePost(t.value.id):await B.likePost(t.value.id)}catch(V){console.error("Failed to update like status in modal:",V),b.error(((f=(x=V.response)==null?void 0:x.data)==null?void 0:f.message)||"点赞操作失败"),t.value&&(t.value.isLiked=c,t.value.likesCount=o,E("postUpdated",t.value))}finally{v.value=!1}},w=async()=>{var x,f;if(!t.value)return;if(!z.isLoggedIn){b.warning("请先登录");return}if(k.value)return;k.value=!0;const c=t.value.isFavorited,o=t.value.favoritesCount||0;t.value.isFavorited=!c,t.value.favoritesCount=c?o-1:o+1,E("postUpdated",t.value);try{c?await B.unfavoritePost(t.value.id):await B.favoritePost(t.value.id)}catch(V){console.error("Failed to update favorite status in modal:",V),b.error(((f=(x=V.response)==null?void 0:x.data)==null?void 0:f.message)||"收藏操作失败"),t.value&&(t.value.isFavorited=c,t.value.favoritesCount=o,E("postUpdated",t.value))}finally{k.value=!1}},m=async()=>{var c,o,x,f;if(!(!t.value||!D.value.trim())){if(!z.isLoggedIn){b.warning("请先登录再评论");return}r.value=!0;try{const V=await B.createComment(t.value.id,{text:D.value.trim()});if(V&&V.comment){const $={...V.comment,author:{id:((c=z.currentUser)==null?void 0:c.id)??0,name:((o=z.currentUser)==null?void 0:o.name)??"您"}};p.value.unshift($),t.value.commentsCount!==void 0&&(t.value.commentsCount++,E("postUpdated",t.value)),D.value="",b.success("评论成功")}else b.error("评论失败，请重试")}catch(V){console.error("Failed to submit comment in modal:",V),b.error(((f=(x=V.response)==null?void 0:x.data)==null?void 0:f.message)||"发表评论失败")}finally{r.value=!1}}},A=async c=>{var x,f,V;if(!t.value)return;const o=p.value.find($=>$.id===c);if(!o||o.authorId!==((x=z.currentUser)==null?void 0:x.id)){b.warning("无法删除他人评论");return}try{await Re.confirm("确定要删除这条评论吗?","确认删除",{type:"warning"}),await B.deleteComment(c),p.value=p.value.filter($=>$.id!==c),t.value.commentsCount!==void 0&&(t.value.commentsCount--,E("postUpdated",t.value)),b.success("评论已删除")}catch($){$!=="cancel"&&(console.error("Failed to delete comment in modal:",$),b.error(((V=(f=$.response)==null?void 0:f.data)==null?void 0:V.message)||"删除评论失败"))}};return(c,o)=>{const x=Ee("router-link");return l(),S(e(Fe),{modelValue:d.value,"onUpdate:modelValue":o[1]||(o[1]=f=>d.value=f),title:t.value?t.value.title:"帖子详情",width:"70%","before-close":G,onOpened:R,class:"post-detail-modal","append-to-body":""},{footer:s(()=>[i("span",Vt,[a(e(j),{onClick:G},{default:s(()=>o[8]||(o[8]=[T("关闭")])),_:1})])]),default:s(()=>{var f,V;return[C.value?(l(),S(e(me),{key:0,rows:5,animated:""})):L.value?(l(),S(e(fe),{key:1,title:"加载帖子失败",type:"error",description:L.value,"show-icon":"",closable:!1},null,8,["description"])):t.value?(l(),_("div",yt,[i("div",ht,[a(e(ce),{size:40,src:e(ee)((f=t.value.author)==null?void 0:f.avatarUrl)},null,8,["src"]),i("span",kt,I(((V=t.value.author)==null?void 0:V.name)||"匿名用户"),1),i("span",_t,I(P(t.value.createdAt)),1)]),i("p",Ct,I(t.value.content),1),i("div",wt,[a(e(j),{text:"",icon:t.value.isLiked?e(we):e(pe),type:t.value.isLiked?"primary":"",onClick:g,loading:v.value},{default:s(()=>[T(I(t.value.likesCount||0)+" 点赞 ",1)]),_:1},8,["icon","type","loading"]),a(e(j),{text:"",icon:t.value.isFavorited?e(we):e(pe),type:t.value.isFavorited?"warning":"",onClick:w,loading:k.value},{default:s(()=>[T(I(t.value.favoritesCount||0)+" 收藏 ",1)]),_:1},8,["icon","type","loading"]),i("span",null,I(t.value.commentsCount||0)+" 评论",1)]),a(e(Be)),i("div",bt,[o[7]||(o[7]=i("h4",null,"评论",-1)),e(z).isLoggedIn?(l(),_("div",Pt,[a(e(ae),{modelValue:D.value,"onUpdate:modelValue":o[0]||(o[0]=$=>D.value=$),type:"textarea",rows:2,placeholder:"添加评论...",maxlength:"500","show-word-limit":""},null,8,["modelValue"]),a(e(j),{type:"primary",onClick:m,loading:r.value,size:"small",style:{"margin-top":"8px"}},{default:s(()=>o[2]||(o[2]=[T(" 发表 ")])),_:1},8,["loading"])])):(l(),_("div",xt,[a(e(Me),{type:"info",size:"small"},{default:s(()=>[o[4]||(o[4]=T("请")),a(x,{to:{name:"Login",query:{redirect:c.$route.fullPath}}},{default:s(()=>o[3]||(o[3]=[T("登录")])),_:1},8,["to"]),o[5]||(o[5]=T("后发表评论"))]),_:1})])),N.value?(l(),S(e(me),{key:2,rows:3,animated:"",style:{"margin-top":"15px"}})):M.value?(l(),S(e(fe),{key:3,title:"加载评论失败",type:"error",description:M.value,"show-icon":"",closable:!1,size:"small",style:{"margin-top":"15px"}},null,8,["description"])):p.value.length>0?(l(),_("ul",Ft,[(l(!0),_(K,null,Q(p.value,$=>{var H,n,F;return l(),_("li",{key:$.id,class:"comment-item-modal"},[i("div",Et,[a(e(ce),{size:24,src:e(ee)((H=$.author)==null?void 0:H.avatarUrl)},null,8,["src"]),i("span",Ut,I(((n=$.author)==null?void 0:n.name)||"匿名用户"),1),i("span",Lt,I(P($.createdAt)),1),((F=e(z).currentUser)==null?void 0:F.id)===$.authorId?(l(),S(e(j),{key:0,type:"danger",link:"",size:"small",onClick:y=>A($.id),class:"delete-comment-btn"},{default:s(()=>o[6]||(o[6]=[T(" 删除 ")])),_:2},1032,["onClick"])):O("",!0)]),i("p",$t,I($.text),1)])}),128))])):(l(),S(e(ge),{key:5,description:"暂无评论","image-size":60}))])])):(l(),S(e(ge),{key:3,description:"帖子未找到","image-size":100}))]}),_:1},8,["modelValue","title"])}}}),St=oe(It,[["__scopeId","data-v-411f84f9"]]),zt={class:"community-view container"},Tt={class:"community-header"},At={key:0,class:"tags-nav"},Dt={class:"tags-container"},Bt={class:"action-bar"},Mt={class:"right-actions"},Rt={class:"posts-list-section"},jt={key:0,class:"loading-state"},Nt={style:{padding:"14px"}},Ot={style:{display:"flex","align-items":"center","margin-bottom":"10px"}},qt={style:{width:"60%"}},Kt={style:{display:"flex","justify-content":"space-between","align-items":"center","border-top":"1px solid #f0f0f0","padding-top":"10px"}},Qt={key:0,class:"featured-posts"},Wt={class:"regular-posts"},Gt={key:0,class:"pagination-section"},Ht={name:"CommunityView"},Jt=se({...Ht,setup(W){const q=h([]),u=h([]),E=h(""),z=h(!1),d=h("createdAt"),t=h([]),C=h(!1),L=h(null),p=ve({currentPage:1,pageSize:12,total:0}),N=h(!1),M=h(null),D=h(!1),r=ie(()=>q.value.filter(n=>n.isFixed===!0)),v=ie(()=>d.value!=="featured"?t.value.filter(n=>n.isShowcase).slice(0,4):t.value.filter(n=>n.isShowcase)),k=ie(()=>{if(d.value==="featured"){const n=v.value.slice(0,2).map(F=>F.id);return t.value.filter(F=>!n.includes(F.id))}return t.value}),P=async(n=1,F={})=>{C.value=!0,L.value=null;try{const y=F.sortBy||d.value,U=y==="popular"?"likesCount":y==="featured"?"createdAt":y,J={page:n,limit:p.pageSize,sortBy:U};u.value.length>0?J.tags=u.value:delete J.tags,E.value&&(J.search=E.value),y==="featured"&&(J.showcase=!0);const ke=await B.getAllPosts(J);t.value=ke.posts,p.total=ke.totalCount||0,p.currentPage=n}catch(y){console.error("Failed to fetch posts:",y),L.value="加载帖子失败，请稍后再试。",b.error(L.value)}finally{C.value=!1}},R=async()=>{z.value=!0;try{q.value=await Ye.getAllTags(),console.log("[CommunityView] Fetched post tags:",q.value)}catch(n){console.error("[CommunityView] Failed to fetch post tags:",n),b.warning("加载帖子标签失败，但不影响浏览")}finally{z.value=!1}},Y=n=>{u.value.length===1&&u.value[0]===n?u.value=[]:u.value=[n],P(1)},G=()=>{u.value=[],P(1)},g=()=>{p.currentPage=1,P(1)},w=()=>{g()},m=n=>{console.log("Current page:",n),P(n)};te(d,n=>{P(1,{sortBy:n})}),xe(()=>{R(),P(p.currentPage)});const A=le(),c=he(),o=()=>{if(!A.isLoggedIn){b.warning("请先登录再发布分享"),c.push("/login");return}console.log("Navigating to post creation page..."),c.push({name:"CreatePost"})},x=()=>{console.log("Post created, refreshing list..."),P(1)},f=n=>{console.log("Liked post:",n)},V=n=>{console.log("Opening modal for post in CommunityView:",n),typeof n=="number"?(M.value=n,D.value=!0):console.error("Invalid postId received from ShareCard:",n)},$=n=>{console.log("Favorited post:",n)},H=n=>{const F=t.value.findIndex(y=>y.id===n.id);if(F!==-1){const y=t.value[F];y.title=n.title,y.content=n.content??null,y.imageUrl=n.imageUrl??null,y.likesCount=n.likesCount,y.commentsCount=n.commentsCount,y.favoritesCount=n.favoritesCount,y.isLiked=n.isLiked,y.isFavorited=n.isFavorited,t.value[F]=y}};return(n,F)=>{const y=Ee("el-skeleton-item");return l(),_("div",zt,[i("section",Tt,[r.value.length>0?(l(),_("div",At,[a(e(Ne),null,{default:s(()=>[i("div",Dt,[(l(!0),_(K,null,Q(r.value,U=>(l(),S(e(ye),{key:U.id,type:u.value.includes(U.name)?"primary":"info",class:"tag-item",onClick:J=>Y(U.name)},{default:s(()=>[T(I(U.name),1)]),_:2},1032,["type","onClick"]))),128)),u.value.length>0?(l(),S(e(j),{key:0,size:"small",circle:"",icon:e(We),class:"clear-tags-btn",onClick:G,title:"清除标签筛选"},null,8,["icon"])):O("",!0)])]),_:1})])):O("",!0),i("div",Bt,[a(e(Oe),{modelValue:d.value,"onUpdate:modelValue":F[0]||(F[0]=U=>d.value=U),class:"tabs"},{default:s(()=>[a(e(ue),{label:"最新发布",name:"createdAt"}),a(e(ue),{label:"热门讨论",name:"popular"}),a(e(ue),{label:"精选内容",name:"featured"})]),_:1},8,["modelValue"]),i("div",Mt,[a(e(ae),{modelValue:E.value,"onUpdate:modelValue":F[1]||(F[1]=U=>E.value=U),placeholder:"搜索内容...","prefix-icon":"Search",clearable:"",onClear:w,onKeyup:qe(g,["enter"]),class:"search-input"},{append:s(()=>[a(e(j),{icon:e(Ge),onClick:g},null,8,["icon"])]),_:1},8,["modelValue"]),a(e(j),{type:"primary",icon:e(Ke),onClick:o},{default:s(()=>F[5]||(F[5]=[T("发布分享")])),_:1},8,["icon"])])])]),i("section",Rt,[C.value?(l(),_("div",jt,[a(e(re),{gutter:24},{default:s(()=>[(l(!0),_(K,null,Q(p.pageSize>8?8:p.pageSize,U=>(l(),S(e(de),{key:U,xs:24,sm:12,md:8,lg:d.value==="featured"&&v.value.length>0?6:8,xl:(d.value==="featured"&&v.value.length>0,6),style:{"margin-bottom":"20px"}},{default:s(()=>[a(e(me),{style:{width:"100%"},animated:""},{template:s(()=>[a(y,{variant:"image",style:{width:"100%",height:"180px","border-radius":"12px 12px 0 0","margin-bottom":"10px"}}),i("div",Nt,[i("div",Ot,[a(y,{variant:"circle",style:{"margin-right":"10px"}}),i("div",qt,[a(y,{variant:"text",style:{width:"70%","margin-bottom":"4px"}}),a(y,{variant:"text",style:{width:"40%"}})])]),a(y,{variant:"p",style:{width:"100%","margin-bottom":"8px"}}),a(y,{variant:"text",style:{width:"80%","margin-bottom":"4px"}}),a(y,{variant:"text",style:{width:"90%","margin-bottom":"12px"}}),i("div",Kt,[a(y,{variant:"text",style:{width:"20%"}}),a(y,{variant:"text",style:{width:"20%"}}),a(y,{variant:"text",style:{width:"20%"}})])])]),_:1})]),_:2},1032,["lg","xl"]))),128))]),_:1})])):L.value?(l(),S(e(fe),{key:1,title:L.value,type:"error","show-icon":"",closable:!1},null,8,["title"])):(l(),_(K,{key:2},[v.value.length>0&&d.value==="featured"?(l(),_("div",Qt,[a(e(re),{gutter:24},{default:s(()=>[(l(!0),_(K,null,Q(v.value.slice(0,2),U=>(l(),S(e(de),{xs:24,sm:24,md:24,lg:12,xl:12,key:U.id},{default:s(()=>[a(be,{post:U,"is-featured":!0,onLike:f,onComment:V,onFavorite:$,"onUpdate:post":H},null,8,["post"])]),_:2},1024))),128))]),_:1})])):O("",!0),i("div",Wt,[a(e(re),{gutter:24},{default:s(()=>[(l(!0),_(K,null,Q(k.value,U=>(l(),S(e(de),{key:U.id,xs:24,sm:12,md:8,lg:d.value==="featured"&&v.value.length>0?6:8,xl:(d.value==="featured"&&v.value.length>0,6)},{default:s(()=>[a(be,{post:U,onLike:f,onComment:V,onFavorite:$,"onUpdate:post":H},null,8,["post"])]),_:2},1032,["lg","xl"]))),128))]),_:1})]),k.value.length===0?(l(),S(e(ge),{key:1,description:"暂无相关内容，换个筛选条件试试吧！"})):O("",!0)],64))]),!C.value&&!L.value&&p.total>p.pageSize?(l(),_("section",Gt,[a(e(Qe),{background:"",layout:"prev, pager, next",total:p.total,"page-size":p.pageSize,"current-page":p.currentPage,"onUpdate:currentPage":F[2]||(F[2]=U=>p.currentPage=U),onCurrentChange:m},null,8,["total","page-size","current-page"])])):O("",!0),a(gt,{visible:N.value,"onUpdate:visible":F[3]||(F[3]=U=>N.value=U),onPostCreated:x},null,8,["visible"]),a(St,{"post-id":M.value,visible:D.value,"onUpdate:visible":F[4]||(F[4]=U=>D.value=U),onPostUpdated:H},null,8,["post-id","visible"])])}}}),ta=oe(Jt,[["__scopeId","data-v-deedbce1"]]);export{ta as default};
